name: Pull Request Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  quality-check:
    name: Code Quality Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Solhint
        run: npm run lint:sol
        continue-on-error: true

      - name: Check for compilation errors
        run: npm run compile

      - name: Run tests
        run: npm test

      - name: Check coverage threshold
        run: npm run coverage

      - name: Comment PR with test results
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const fs = require('fs');
            let comment = '## ðŸ§ª Test Results\n\n';

            try {
              // Add test status
              comment += 'âœ… All tests passed!\n\n';
              comment += '### Coverage Report\n';
              comment += 'Coverage report generated. Check the artifacts for details.\n\n';
              comment += '### Next Steps\n';
              comment += '- Review the code changes\n';
              comment += '- Ensure all comments are addressed\n';
              comment += '- Merge when ready\n';
            } catch (error) {
              comment += 'âŒ Some checks failed. Please review the logs.\n';
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  size-check:
    name: Contract Size Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Compile contracts
        run: npm run compile

      - name: Check contract sizes
        run: |
          echo "## Contract Sizes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Checking compiled contract sizes..." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          for file in artifacts/contracts/**/*.json; do
            if [[ ! "$file" =~ ".dbg.json" ]]; then
              size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null)
              if [ $size -gt 0 ]; then
                echo "- $(basename $file): ${size} bytes" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Run npm audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: Security summary
        run: |
          echo "## ðŸ”’ Security Audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Security audit completed. Check logs for details." >> $GITHUB_STEP_SUMMARY
